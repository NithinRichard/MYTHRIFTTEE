{% schema %}
{
  "name": "Complete the Look",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "COMPLETE THE LOOK"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 4,
      "step": 1,
      "default": 3,
      "label": "Maximum products to show"
    }
  ],
  "blocks": [
    {
      "type": "complete_look_item",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Complete the Look"
    }
  ]
}
{% endschema %}

<div class="complete-the-look-section page-width">
  {% if section.settings.heading != blank %}
    <h2 class="complete-the-look-heading">{{ section.settings.heading }}</h2>
  {% endif %}

  <div class="complete-the-look-grid">
    {%- if recommendations.performed -%}
      {%- if recommendations.products_count > 0 -%}
        {%- for product in recommendations.products -%}
          <div class="complete-the-look-item">
            <a href="{{ product.url }}" class="complete-the-look-link">
              <div class="complete-the-look-image-wrapper">
                {{ product.featured_image | image_url: width: 600 | image_tag: loading: 'lazy', class: 'complete-the-look-image' }}
              </div>
              <div class="complete-the-look-info">
                <h3 class="complete-the-look-title">{{ product.title }}</h3>
                <span class="complete-the-look-price">{{ product.price | money }}</span>
              </div>
            </a>
          </div>
        {%- endfor -%}
      {%- endif -%}
    {%- else -%}
      {%- if section.blocks.size > 0 -%}
        {%- for block in section.blocks -%}
          {%- if block.settings.product != blank -%}
            <div class="complete-the-look-item">
              <a href="{{ block.settings.product.url }}" class="complete-the-look-link">
                <div class="complete-the-look-image-wrapper">
                  {{ block.settings.product.featured_image | image_url: width: 600 | image_tag: loading: 'lazy', class: 'complete-the-look-image' }}
                </div>
                <div class="complete-the-look-info">
                  <h3 class="complete-the-look-title">{{ block.settings.product.title }}</h3>
                  <span class="complete-the-look-price">{{ block.settings.product.price | money }}</span>
                </div>
              </a>
            </div>
          {%- endif -%}
        {%- endfor -%}
      {%- else -%}
        <div id="complete-the-look-recommendations" data-product-id="{{ product.id }}" data-limit="{{ section.settings.products_to_show }}">
          <!-- Recommendations will be loaded here via JS -->
        </div>
      {%- endif -%}
    {%- endif -%}
  </div>
</div>

<style>
  .complete-the-look-section {
    margin-top: 4rem;
    margin-bottom: 4rem;
  }

  .complete-the-look-heading {
    font-family: 'VCR OSD Mono', monospace;
    text-transform: uppercase;
    margin-bottom: 2rem;
    font-size: 1.5rem;
  }

  .complete-the-look-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* Mobile: 2 columns */
    gap: 1rem;
  }

  @media screen and (min-width: 750px) {
    .complete-the-look-grid {
      grid-template-columns: repeat(4, 1fr); /* Desktop: 4 columns fixed to prevent stretching */
      gap: 1.5rem;
    }
  }

  .complete-the-look-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .complete-the-look-image-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 3 / 4;
    overflow: hidden;
    margin-bottom: 1rem;
    background-color: #f4f4f4;
    padding: 1rem; /* Add padding so image is "inside" */
  }

  .complete-the-look-image {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Ensure whole image is visible */
    transition: transform 0.5s ease;
  }

  .complete-the-look-link:hover .complete-the-look-image {
    transform: scale(1.05);
  }

  .complete-the-look-title {
    font-family: 'Yeezy TStar', sans-serif;
    font-size: 1rem;
    margin: 0 0 0.5rem 0;
    text-transform: uppercase;
  }

  .complete-the-look-price {
    font-family: 'VCR OSD Mono', monospace;
    font-size: 0.9rem;
    opacity: 0.8;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('complete-the-look-recommendations');
    if (container) {
      const productId = container.dataset.productId;
      const limit = container.dataset.limit;
      const url = `/recommendations/products?section_id={{ section.id }}&product_id=${productId}&limit=${limit}&intent=complementary`;

      fetch(url)
        .then(response => response.text())
        .then(text => {
          const html = document.createElement('div');
          html.innerHTML = text;
          const recommendations = html.querySelector('.complete-the-look-grid');

          if (recommendations && recommendations.innerHTML.trim().length > 0) {
            container.innerHTML = recommendations.innerHTML;
            container.style.display = 'contents'; // Unwrap
          } else {
            // Fallback to related if complementary is empty? Or just hide.
            // For now, let's hide the section if empty
            if (!recommendations || recommendations.innerHTML.trim().length === 0) {
               document.querySelector('.complete-the-look-section').style.display = 'none';
            }
          }
        })
        .catch(e => {
          console.error(e);
          document.querySelector('.complete-the-look-section').style.display = 'none';
        });
    }
  });
</script>
