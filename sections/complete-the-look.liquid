{% schema %}
{
  "name": "Complete the Look",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "COMPLETE THE LOOK"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 4,
      "step": 1,
      "default": 3,
      "label": "Maximum products to show"
    }
  ],
  "blocks": [
    {
      "type": "product_item",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Complete the Look"
    }
  ]
}
{% endschema %}

<div class="complete-the-look-section page-width">
  {% if section.settings.heading != blank %}
    <h2 class="complete-the-look-heading">{{ section.settings.heading }}</h2>
  {% endif %}

  <div class="complete-the-look-grid">
    {%- if section.blocks.size > 0 -%}
      {%- for block in section.blocks -%}
        {%- if block.settings.product != blank -%}
          <div class="complete-the-look-item">
            {% render 'product-card', product_card_product: block.settings.product %}
          </div>
        {%- endif -%}
      {%- endfor -%}
    {%- else -%}
      <div id="complete-the-look-recommendations" data-product-id="{{ product.id }}" data-limit="{{ section.settings.products_to_show }}">
        <!-- Recommendations will be loaded here via JS -->
      </div>
    {%- endif -%}
  </div>
</div>

<style>
  .complete-the-look-section {
    margin-top: 4rem;
    margin-bottom: 4rem;
  }

  .complete-the-look-heading {
    font-family: 'VCR OSD Mono', monospace;
    text-transform: uppercase;
    margin-bottom: 2rem;
    font-size: 1.5rem;
  }

  .complete-the-look-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
  }

  /* Reuse existing product card styles but ensure they fit */
  .complete-the-look-item .card {
    height: 100%;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('complete-the-look-recommendations');
    if (container) {
      const productId = container.dataset.productId;
      const limit = container.dataset.limit;
      const url = `/recommendations/products?section_id={{ section.id }}&product_id=${productId}&limit=${limit}&intent=complementary`;

      fetch(url)
        .then(response => response.text())
        .then(text => {
          const html = document.createElement('div');
          html.innerHTML = text;
          const recommendations = html.querySelector('.complete-the-look-grid');

          if (recommendations && recommendations.innerHTML.trim().length > 0) {
            container.innerHTML = recommendations.innerHTML;
            container.style.display = 'contents'; // Unwrap
          } else {
            // Fallback to related if complementary is empty? Or just hide.
            // For now, let's hide the section if empty
            if (!recommendations || recommendations.innerHTML.trim().length === 0) {
               document.querySelector('.complete-the-look-section').style.display = 'none';
            }
          }
        })
        .catch(e => {
          console.error(e);
          document.querySelector('.complete-the-look-section').style.display = 'none';
        });
    }
  });
</script>
